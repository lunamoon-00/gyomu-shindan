# C1 / C2 / H1 実装レビュー結果

差分反映後のコードを確認し、指摘事項をまとめました。

---

## 1. 総評

| 項目 | 判定 | コメント |
|------|------|----------|
| C1 env化 | ✅ 問題なし | ハードコード削除・env 参照の切り替えは適切 |
| C2 試算値注釈 | ✅ 問題なし | 位置・文言とも妥当 |
| H1 メール形式エラー | ⚠️ 軽微な改善余地 | 動作は妥当。UX の細部で改善の余地あり |
| 既存機能への影響 | ✅ 問題なし | 挙動の変化・破綻は見当たらない |

---

## 2. 詳細チェック

### 2.1 env 化漏れ

| チェック項目 | 結果 |
|--------------|------|
| GAS URL のハードコード | ✅ なし。`config.ts` のみで env 参照 |
| 相談メールのハードコード | ✅ なし。同上 |
| API ルート | ✅ `getGasUrl()` を利用。未設定時は 503 を返却 |
| page.tsx | ✅ `getConsultEmail()` を利用 |

**補足:** `config.ts` 冒頭のコメントに「フォールバック（後方互換）」の記述が残っています。フォールバックは削除済みなので、コメント修正を推奨します。

---

### 2.2 試算値注釈の位置・文言

| コンポーネント | 位置 | 文言 | 評価 |
|----------------|------|------|------|
| ResultKpiCards | KPI カード群の直上 | ※試算値・目安です。実際の数値は状況により異なります。 | ✅ 適切 |
| RoiCards | 「削減見込み」の直下 | ※試算値です | ✅ 適切 |

**補足:** 優先度・ボトルネック・ロードマップは数値的な「試算」ではないため、注釈は不要です。KPI と ROI のみで十分です。

---

### 2.3 メール形式エラーの表示・解除タイミング

| 項目 | 実装 | 評価 |
|------|------|------|
| 表示条件 | 不正メール形式で送信時 | ✅ 妥当 |
| 表示内容 | 「正しいメールアドレスを入力してください。」 | ✅ 明確 |
| 親エラーとの併存 | `error ?? localError` で API エラーを優先 | ✅ 妥当 |
| 解除タイミング | 次回送信時に `setLocalError(null)` | ⚠️ 改善余地あり |

**改善案（Low）:** メール入力欄の `onChange` で `setLocalError(null)` を呼ぶと、修正と同時にエラーが消え、より自然な UX になります。現状の「次回送信時に消える」仕様でも実務上は問題ありません。

---

### 2.4 既存機能への影響

| 機能 | 影響 |
|------|------|
| 診断送信 | なし。env 未設定時は 503 を返す想定どおり |
| モック診断 | なし。`NEXT_PUBLIC_USE_MOCK=true` で従来どおり動作 |
| 相談送信 | なし。env 未設定時は「設定が完了していません」と表示 |
| 結果画面 | なし。注釈追加のみで表示内容・構成は維持 |
| エラーハンドリング | なし。既存の `error` 表示はそのまま動作 |

---

## 3. 残存 Critical / High 指摘

現状、**Critical / High に該当する残存指摘はありません。**  
C1 / C2 / H1 は仕様どおり実装されています。

---

## 4. 任意の改善（優先度順）

| 優先度 | 内容 | 種別 |
|--------|------|------|
| 1 | `config.ts` のコメント「フォールバック（後方互換）」を削除または修正 | ドキュメント |
| 2 | メール入力の `onChange` で `localError` をクリアする | UX（任意） |

---

## 5. 修正案（任意対応用）

### config.ts コメント修正

```diff
- * 環境変数で上書き可能。未設定時は従来値をフォールバック（後方互換）
+ * 環境変数から取得。未設定時は空文字を返します。
 *
  * 【重要】
- * - .env.local を作成して値を設定すると、フォールバックを上書き
+ * - .env.local に GAS_URL, NEXT_PUBLIC_CONSULT_EMAIL を設定してください
```

### ConsultationForm: onChange で localError をクリア（任意）

```diff
      <input
        type="email"
        value={email}
-        onChange={(e) => setEmail(e.target.value)}
+        onChange={(e) => {
+          setEmail(e.target.value);
+          setLocalError(null);
+        }}
```

---

以上です。実装は仕様を満たしており、任意対応以外の追加修正は不要です。
