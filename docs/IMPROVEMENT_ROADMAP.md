# 業務効率化診断ツール 改善ロードマップ

上級者レベルに近づく教材として、実務で通用する観点で整理した改善計画です。

---

## 1. 現在の試作で起きやすい問題点

### 1.1 バグ・不安定要因

| 問題 | 内容 | 発生しやすい場面 |
|------|------|------------------|
| APIレスポンスの型保証なし | `realSubmit` で `res.json()` をそのまま返す。GASが想定外の形式を返すとクラッシュ | GAS仕様変更・エラー応答 |
| resultの型ガード不足 | `handleConsult` で `result?.bottleneckTask` を使うが、`result.status === "error"` のときはundefined。ResultScreenは成功時のみなので実害は小さいが、型が曖昧 | 将来的な条件分岐追加時 |
| fetchのHTTPエラーを握りつぶす | `res.ok` をチェックしていない。404/500でも `res.json()` を実行してしまう | GAS障害・URL変更 |
| 二重送信 | 送信中にボタンを連打すると複数リクエストが飛ぶ可能性 | 遅い回線・不安定なGAS |

### 1.2 設計の弱さ

| 問題 | 内容 |
|------|------|
| page.tsx が肥大 | 700行超。フォームUI・状態・送信・モーダルが1ファイルに集中 |
| 責務の混在 | `apiResponseToResultData` が validation.ts にあり、本来は `lib/` の変換レイヤーに寄せるべき |
| GAS_URLの重複 | diagnosis と consult のルートで同じURLをハードコード |
| 定数・設定の散在 | CONSULT_EMAIL が page.tsx 内、GAS_URL が各API、USE_MOCK が submitDiagnosis に分散 |
| テスト未整備 | ユニットテスト・E2Eテストがない。変更の影響範囲を手動でしか確認できない |

### 1.3 運用面の弱さ

| 問題 | 内容 |
|------|------|
| ログ設計なし | `console.error` のみ。何が起きたか追いづらい |
| 監視・アラートなし | GAS障害・送信失敗を検知する仕組みがない |
| 本番/開発の切り替えがコード変更 | USE_MOCK はコード内フラグ。環境変数で切り替えるべき |

### 1.4 セキュリティ・設定管理の弱さ

| 問題 | 内容 | リスク |
|------|------|--------|
| GAS URLのハードコード | ソースに直書き。リポジトリ公開でURLが露出 | 悪用・スパム送信 |
| CONSULT_EMAILのハードコード | 同上 | スパム・情報漏洩 |
| 入力値のサニタイズなし | formData をそのまま JSON 化してGASに送信 | 想定外データ・インジェクション（GAS側次第） |
| レート制限なし | 同一IPから何度でも送信可能 | DoS・スパム |

### 1.5 UX上の弱さ

| 問題 | 内容 |
|------|------|
| 送信完了後の戻り先が不明確 | モーダルを閉じるとフォームのまま。トップにスクロールするなどしていない |
| ネットワークエラー時のメッセージが汎用的 | 「通信エラー」だけ。リトライのヒントがない |
| モバイルでのステップ感 | 9ステップが長く感じる可能性。進捗がどこまでか分かりにくい箇所あり |

---

## 2. 改善優先順位（高→低）

| 順位 | 項目 | 理由 |
|------|------|------|
| 1 | 設定値の環境変数化 | セキュリティと運用の基礎。GAS URL・メールアドレスが露出している状態は即時リスク |
| 2 | APIのエラーハンドリング強化 | `res.ok` 未チェック・型崩れは本番でクラッシュの元。修正が簡単で効果が大きい |
| 3 | 二重送信防止 | 実装が軽く、UXとデータ整合性の両方に効く |
| 4 | 定数・設定の集約 | 散在していると変更漏れやバグの温床。`lib/config.ts` などに集約 |
| 5 | page.tsx の責務分割 | 可読性とテスタビリティ向上。急ぎではないが、以降の改善の土台になる |
| 6 | ログ設計 | 運用で困ってからでも間に合うが、早めにあると障害調査が楽 |
| 7 | テスト導入 | 時間はかかるが、教材として「テストの書き方」を学べる価値が高い |
| 8 | UX細部の改善 | 重要だが、安定化・設計整理が先 |

---

## 3. 改善ロードマップ（3段階）

### Phase 1: 安定化（すぐやる）

**目的**: 本番で落ちにくく、設定を安全に扱えるようにする

- 環境変数で GAS URL・CONSULT_EMAIL を管理
- API で `res.ok` チェック、HTTP エラー時の適切な JSON 返却
- 送信ボタンの二重送信防止（disabled + クリック無効化）
- `apiResponseToResultData` の入力型ガード（想定外レスポンス時のフォールバック）

### Phase 2: 実務品質に寄せる（設計整理）

**目的**: 変更しやすく、説明しやすい構成にする

- 定数・設定を `lib/config.ts` に集約
- `page.tsx` を hooks（useDiagnosisForm, useSubmit 等）とUIに分割
- API ルートの共通化（GAS呼び出しロジックを1箇所に）
- エラーメッセージの定数化・多言語化の芽

### Phase 3: 再利用・商品化しやすくする（テンプレ化）

**目的**: 他プロジェクトや教材として流用しやすくする

- README に環境構築・GAS連携・デプロイ手順を文書化
- `.env.example` で必要な環境変数を明示
- オプションでログ出力・監視フックを差し込める設計
- フォーム項目を設定で増減できる拡張ポイントの整理

---

## 4. 具体的タスク一覧

### Phase 1 タスク

| No | タスク | 目的 | 完了条件 | 目安時間 |
|----|--------|------|----------|----------|
| 1-1 | `.env.example` を作成 | 必要な環境変数を明文化 | `GAS_URL`, `CONSULT_EMAIL` が記載され、README で参照できる | 15分 |
| 1-2 | APIルートで `process.env.GAS_URL` を使う | 機密をコードから排除 | diagnosis/consult 両方で env 参照、ハードコード削除 | 30分 |
| 1-3 | page.tsx で `process.env.NEXT_PUBLIC_CONSULT_EMAIL` を使う | 同上 | CONSULT_EMAIL のハードコード削除 | 20分 |
| 1-4 | diagnosis API に `res.ok` チェックを追加 | HTTP エラー時を正しく処理 | 4xx/5xx で適切な JSON を返し、クラッシュしない | 30分 |
| 1-5 | consult API に `res.ok` チェックを追加 | 同上 | 同上 | 20分 |
| 1-6 | realSubmit でレスポンス型チェック | 想定外形式で落ちない | status が期待値でなければ error として扱う | 45分 |
| 1-7 | 送信ボタンに二重送信防止 | 連打で複数リクエストを防ぐ | 送信中はクリック無効、`handleSubmit` 内で早期 return | 30分 |
| 1-8 | apiResponseToResultData の型ガード | GASの変なレスポンスで落ちない | 必須プロパティがない場合のフォールバック | 30分 |

### Phase 2 タスク

| No | タスク | 目的 | 完了条件 | 目安時間 |
|----|--------|------|----------|----------|
| 2-1 | `lib/config.ts` を作成 | 定数・設定の一元管理 | GAS_URL, CONSULT_EMAIL, デフォルト値が1ファイルに集約 | 45分 |
| 2-2 | GAS呼び出しを共通関数に抽出 | APIルートの重複削除 | `lib/gasClient.ts` 等で POST 処理を共通化 | 60分 |
| 2-3 | `useDiagnosisForm` カスタムフック作成 | page.tsx の状態を分離 | formData, validationErrors, updateForm, validate を提供 | 60分 |
| 2-4 | `useSubmit` カスタムフック作成 | 送信ロジックを分離 | submit, isLoading, result, handleConsult を提供 | 60分 |
| 2-5 | page.tsx からフォームUIを抽出 | 1ファイルの行数削減 | FormSteps 等のコンポーネントに分割、page は組み立てのみ | 90分 |
| 2-6 | apiResponseToResultData を lib に移動 | 責務の整理 | validation から分離し、`lib/resultMapper.ts` 等に配置 | 30分 |
| 2-7 | エラーメッセージを定数化 | 文言の一元管理 | `lib/messages.ts` に集約、API・UI両方から参照 | 45分 |

### Phase 3 タスク

| No | タスク | 目的 | 完了条件 | 目安時間 |
|----|--------|------|----------|----------|
| 3-1 | README に環境構築手順を追加 | 新規参加者が立ち上げやすい | npm install, .env 設定, npm run dev で動くまで | 45分 |
| 3-2 | README に GAS 連携手順を追加 | バックエンドのつなぎ方が分かる | doPost の受信形式、action の分岐、Slack通知の概要 | 60分 |
| 3-3 | README に Vercel デプロイ手順を追加 | 本番デプロイを再現可能に | 環境変数の設定、ブランチ連携 | 30分 |
| 3-4 | フォーム項目の設定化（任意） | 項目追加をコード変更最小で可能に | 定数配列で項目定義、page はそれをループ | 90分 |
| 3-5 | ログ出力の枠組み追加（任意） | 運用時の調査を容易に | 送信成功/失敗時に構造化ログを出力する関数 | 60分 |

---

## 5. このプロジェクトで学べる「上級者スキル」一覧

| スキル | 対応タスク | 学べること |
|--------|------------|------------|
| 設定値管理 | 1-1〜1-3, 2-1 | 環境変数、.env.example、機密の扱い |
| 例外処理・エラーハンドリング | 1-4〜1-6, 1-8 | res.ok、型ガード、フォールバック |
| API設計 | 1-4〜1-6, 2-2 | HTTPステータス、JSON契約、プロキシ設計 |
| 責務分離 | 2-3〜2-6 | カスタムフック、レイヤー分離、変換ロジック |
| 再利用設計 | 2-2, 2-5, 3-4 | 共通化、コンポーネント設計、設定駆動 |
| ドキュメント設計 | 3-1〜3-3 | 環境構築、API連携、デプロイの文書化 |
| ログ設計 | 3-5 | 構造化ログ、運用目線の情報 |
| セキュリティ意識 | Phase 1 全体 | 機密の露出防止、入力検証 |
| テスタビリティ（今後の発展） | Phase 2 の hooks 化後 | ユニットテスト、モック、E2E |

---

## 6. 進め方の目安

- **Phase 1**: 1〜2日（1日2〜3タスク）
- **Phase 2**: 2〜3日（hooks 化はまとめてやると流れが掴みやすい）
- **Phase 3**: 1〜2日（ドキュメント中心）

各タスクは独立しているので、優先度に合わせて並び替え可能です。
